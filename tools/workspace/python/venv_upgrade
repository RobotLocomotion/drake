#!/bin/bash
#
# Drake script to upgrade our requirements lockfile.
# - Users should make edits to requirements.in, and then
# - run this script to compile requirements.in to requirements.txt.

set -eux -o pipefail

generate_requirements() {
    in_name="$1.in"
    out_name="$1.txt"

    # Remove any existing lockfile to avoid it being used as a baseline.
    rm -f "$out_name" requirements.tmp

    # Compile requirements.in to its locked form of requirements.txt.
    "$venv_root"/venv.jazzband/bin/pip-compile \
        --verbose \
        --output-file requirements.tmp \
        "$in_name"

    # Edit the comment atop the file that explains how to upgrade.
    echo '# This file is generated by' \
         'drake/tools/workspace/python/venv_upgrade;' \
         'do not edit.' > "$out_name"
    tail -n+6 requirements.tmp >> "$out_name"

    # Remove the temporary file.
    rm requirements.tmp
}

# Determine what platform we are on.
if [[ "$(uname)" == "Darwin" ]]; then
    readonly platform=mac
else
    readonly platform=ubuntu
fi

# Chdir to the Drake root.
cd "$(dirname $0)/../../.."
readonly venv_root="$(bazel info output_base).venv"

# Chdir to where the requirements files are located.
cd "setup/$platform/source_distribution"

generate_requirements requirements-build
generate_requirements requirements-test
