pods_find_pkg_config(bullet)

if(MATLAB_FOUND)
  add_rbm_mex(compareParsersmex)
endif()

add_executable(urdfKinTest urdfKinTest.cpp)
target_link_libraries(urdfKinTest drakeRBM)
if(bullet_FOUND)
  add_executable(urdfCollisionTest urdfCollisionTest.cpp)
  target_link_libraries(urdfCollisionTest drakeRBM)
endif()

add_executable(urdfManipulatorDynamicsTest urdfManipulatorDynamicsTest.cpp)
target_link_libraries(urdfManipulatorDynamicsTest drakeRBM)

if(NOT WIN32)
  # this test does not compile on MSVC 2010 because of the use of variadic templates
  add_executable(testKinematicsCacheChecks testKinematicsCacheChecks.cpp)
  target_link_libraries(testKinematicsCacheChecks drakeRBM)
  add_test(NAME testKinematicsCacheChecks WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}" COMMAND testKinematicsCacheChecks)
endif()

macro(add_ik_cpp)
  add_executable(${ARGV} ${ARGV}.cpp)
  target_link_libraries(${ARGV} drakeRigidBodyConstraint drakeIK)
  add_test(NAME ${ARGV} WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}" COMMAND ${ARGV})
endmacro()

macro(add_ik_gtest)
  add_executable(${ARGV} ${ARGV}.cpp)
  target_link_libraries(${ARGV} drakeRigidBodyConstraint drakeIK
    ${GTEST_BOTH_LIBRARIES})
  add_test(NAME ${ARGV} WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}" COMMAND ${ARGV})
endmacro()

if(gurobi_FOUND)
  add_ik_cpp(testApproximateIK)
endif()

pods_find_pkg_config(snopt_c)
pods_find_pkg_config(ipopt)

if(snopt_c_FOUND OR ipopt_FOUND)
  add_ik_gtest(testIK)
  add_ik_gtest(testIKpointwise)
endif()
if (snopt_c_FOUND)
  add_ik_gtest(testIKMoreConstraints)
  add_ik_gtest(testIKtraj)
endif()

add_executable(debugManipulatorDynamics debugManipulatorDynamics.cpp)
target_link_libraries(debugManipulatorDynamics drakeRBM)

add_executable(benchmarkRigidBodyTree benchmarkRigidBodyTree.cpp)
target_link_libraries(benchmarkRigidBodyTree drakeRBM)

if(MATLAB_FOUND)
  macro(add_ikoptions_mex)
    add_mex(${ARGV} ${ARGV}.cpp)
    target_link_libraries(${ARGV} drakeRBM drakeMexUtil drakeIKoptions)
  endmacro()
  add_ikoptions_mex(testIKoptionsmex)
endif()

if(bullet_FOUND)
  add_executable(bullet_collision_zero_rad_sphere_test bullet_collision_zero_rad_sphere_test.cpp)
  target_link_libraries(bullet_collision_zero_rad_sphere_test drakeRBM)
  add_test(NAME bullet_collision_zero_rad_sphere_test COMMAND bullet_collision_zero_rad_sphere_test)
endif()

if(lcm_FOUND)
  add_executable(testMassSpringDamper testMassSpringDamper.cpp)
  target_link_libraries(testMassSpringDamper drakeRBSystem ${GTEST_BOTH_LIBRARIES})
  add_test(NAME testMassSpringDamper COMMAND testMassSpringDamper)

  if(bullet_FOUND)
    add_executable(testLidar lidarTest.cpp)
    add_dependencies(testLidar drake_lcmtypes_hpp)
    target_link_libraries(testLidar drakeRBSystem lcm)
    add_test(NAME testLidar COMMAND testLidar)
  endif()

  add_executable(testAccelerometer testAccelerometer.cpp)
  target_link_libraries(testAccelerometer drakeRBSystem ${GTEST_BOTH_LIBRARIES})
  add_test(NAME testAccelerometer COMMAND testAccelerometer)

  add_executable(testGyroscope testGyroscope.cpp)
  target_link_libraries(testGyroscope drakeRBSystem ${GTEST_BOTH_LIBRARIES})
  add_test(NAME testGyroscope COMMAND testGyroscope)

  add_executable(testMagnetometer testMagnetometer.cpp)
  target_link_libraries(testMagnetometer drakeRBSystem ${GTEST_BOTH_LIBRARIES})
  add_test(NAME testMagnetometer COMMAND testMagnetometer)

  add_executable(compareRigidBodySystems compareRigidBodySystems.cpp)
  target_link_libraries(compareRigidBodySystems drakeRBSystem ${GTEST_BOTH_LIBRARIES})
  add_test(NAME compareAcrobotURDFtoSDF COMMAND compareRigidBodySystems Acrobot.urdf Acrobot.sdf WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}/examples/Acrobot")

  if(snopt_c_FOUND)
    add_test(NAME comparePriusURDFtoSDF COMMAND compareRigidBodySystems prius.sdf prius.urdf WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}/examples/Cars/models/prius")
  endif()

  add_executable(load_model_test load_model_test.cc)
  target_link_libraries(load_model_test drakeRBSystem ${GTEST_BOTH_LIBRARIES})
  add_test(NAME load_model_test COMMAND load_model_test)
endif()

add_executable(testXmlUtil testXmlUtil.cpp)
target_link_libraries(testXmlUtil drakeXMLUtil ${GTEST_BOTH_LIBRARIES})
add_test(NAME testXmlUtil COMMAND testXmlUtil)

add_executable(urdf_parser_test urdf_parser_test.cc)
target_link_libraries(urdf_parser_test drakeRBM ${GTEST_BOTH_LIBRARIES})
add_test(NAME urdf_parser_test COMMAND urdf_parser_test)

add_executable(rigid_body_test rigid_body_test.cc)
target_link_libraries(rigid_body_test drakeRBSystem ${GTEST_BOTH_LIBRARIES})
add_test(NAME rigid_body_test COMMAND rigid_body_test)

add_matlab_test(NAME systems/plants/test/addRobotFromURDFStringTest OPTIONAL bullet COMMAND addRobotFromURDFStringTest)
add_matlab_test(NAME systems/plants/test/andresFallingBlockTest OPTIONAL bullet COMMAND andresFallingBlockTest)
add_matlab_test(NAME systems/plants/test/bodyKinTest OPTIONAL bullet COMMAND bodyKinTest)
add_matlab_test(NAME systems/plants/test/bullet_collision_all_bodies_jac_test REQUIRES bullet COMMAND bullet_collision_all_bodies_jac_test)
add_matlab_test(NAME systems/plants/test/bullet_collision_closest_distance_jac_test REQUIRES bullet lcm libbot COMMAND bullet_collision_closest_distance_jac_test)
add_matlab_test(NAME systems/plants/test/bullet_collision_zero_rad_sphere_test REQUIRES bullet COMMAND bullet_collision_zero_rad_sphere_test)
add_matlab_test(NAME systems/plants/test/bullet_raycast_test REQUIRES bullet COMMAND bullet_raycast_test)
# add_matlab_test(NAME systems/plants/test/collidingPointsTest REQUIRES bullet lcm COMMAND collidingPointsTest)  # FIXME: see #2320
add_matlab_test(NAME systems/plants/test/collisionDetectBoxTest REQUIRES bullet lcm libbot COMMAND collisionDetectBoxTest)
add_matlab_test(NAME systems/plants/test/collisionDetectCHullTest REQUIRES bullet lcm libbot COMMAND collisionDetectCHullTest)
add_matlab_test(NAME systems/plants/test/collisionDetectCapsuleTest REQUIRES bullet lcm libbot COMMAND collisionDetectCapsuleTest)
add_matlab_test(NAME systems/plants/test/collisionDetectGradTest REQUIRES lcm libbot OPTIONAL bullet COMMAND collisionDetectGradTest)
add_matlab_test(NAME systems/plants/test/collisionDetectSphereTest REQUIRES bullet lcm libbot COMMAND collisionDetectSphereTest)
add_matlab_test(NAME systems/plants/test/compareParsers REQUIRES avl spotless xfoil OPTIONAL bullet COMMAND compareParsers)
add_matlab_test(NAME systems/plants/test/contactNormalsTest OPTIONAL bullet COMMAND contactNormalsTest)
add_matlab_test(NAME systems/plants/test/contactSensorTest OPTIONAL gurobi snopt COMMAND contactSensorTest)
add_matlab_test(NAME systems/plants/test/coordinateSystemTest OPTIONAL bullet gurobi COMMAND coordinateSystemTest)
add_matlab_test(NAME systems/plants/test/fallingBrickLCP OPTIONAL bullet gurobi snopt COMMAND fallingBrickLCP)
add_matlab_test(NAME systems/plants/test/fallingCapsulesTest OPTIONAL bullet gurobi snopt COMMAND fallingCapsulesTest)
add_matlab_test(NAME systems/plants/test/ignoreSelfCollisionsTest OPTIONAL bullet COMMAND ignoreSelfCollisionsTest)
add_matlab_test(NAME systems/plants/test/linearize_test COMMAND linearize_test)
add_matlab_test(NAME systems/plants/test/momentumTest OPTIONAL gurobi COMMAND momentumTest)
add_matlab_test(NAME systems/plants/test/moveSpatialMassMatrixTest COMMAND moveSpatialMassMatrixTest)
add_matlab_test(NAME systems/plants/test/multiRobotTest OPTIONAL bullet gurobi snopt COMMAND multiRobotTest)
add_matlab_test(NAME systems/plants/test/simulinkDependency OPTIONAL bullet snopt COMMAND simulinkDependency)
add_matlab_test(NAME systems/plants/test/testApproximateIK OPTIONAL bullet gurobi COMMAND testApproximateIK)
add_matlab_test(NAME systems/plants/test/testBrickKinematics OPTIONAL bullet COMMAND testBrickKinematics)
add_matlab_test(NAME systems/plants/test/testCOM OPTIONAL bullet COMMAND testCOM)
add_matlab_test(NAME systems/plants/test/testCenterOfMassJacobianDotTimesV OPTIONAL bullet COMMAND testCenterOfMassJacobianDotTimesV)
add_matlab_test(NAME systems/plants/test/testCentroidalMomentumMatrix OPTIONAL bullet COMMAND testCentroidalMomentumMatrix)
add_matlab_test(NAME systems/plants/test/testCentroidalMomentumMatrixDotTimesV OPTIONAL bullet COMMAND testCentroidalMomentumMatrixDotTimesV)
add_matlab_test(NAME systems/plants/test/testCollisionDetectFromPoints REQUIRES bullet OPTIONAL gurobi snopt COMMAND testCollisionDetectFromPoints)
add_matlab_test(NAME systems/plants/test/testCollisionFilterGroups OPTIONAL bullet COMMAND testCollisionFilterGroups)
add_matlab_test(NAME systems/plants/test/testContactConstraintsMex REQUIRES bullet COMMAND testContactConstraintsMex)
add_matlab_test(NAME systems/plants/test/testFindAncestorBodies OPTIONAL bullet COMMAND testFindAncestorBodies)
add_matlab_test(NAME systems/plants/test/testFindKinematicPath OPTIONAL bullet COMMAND testFindKinematicPath)
add_matlab_test(NAME systems/plants/test/testFloatingBaseDynamics OPTIONAL bullet gurobi snopt COMMAND testFloatingBaseDynamics)
add_matlab_test(NAME systems/plants/test/testFloatingMassSpringDamperForceGradients OPTIONAL bullet COMMAND testFloatingMassSpringDamperForceGradients)
add_matlab_test(NAME systems/plants/test/testForwardJacDotTimesV OPTIONAL bullet COMMAND testForwardJacDotTimesV)
add_matlab_test(NAME systems/plants/test/testForwardKinRot OPTIONAL bullet COMMAND testForwardKinRot)
add_matlab_test(NAME systems/plants/test/testFrameParser OPTIONAL bullet COMMAND testFrameParser)
add_matlab_test(NAME systems/plants/test/testGeometricJacobian OPTIONAL bullet COMMAND testGeometricJacobian)
add_matlab_test(NAME systems/plants/test/testGeometricJacobianDotTimesV OPTIONAL bullet COMMAND testGeometricJacobianDotTimesV)
add_matlab_test(NAME systems/plants/test/testGeometricJacobianDotV OPTIONAL bullet COMMAND testGeometricJacobianDotV)
add_matlab_test(NAME systems/plants/test/testGradients OPTIONAL bullet COMMAND testGradients)
add_matlab_test(NAME systems/plants/test/testHybridMode OPTIONAL bullet snopt COMMAND testHybridMode)
add_matlab_test(NAME systems/plants/test/testHybridRBM OPTIONAL bullet snopt COMMAND testHybridRBM)
add_matlab_test(NAME systems/plants/test/testIKoptions OPTIONAL bullet COMMAND testIKoptions)
add_matlab_test(NAME systems/plants/test/testIndices OPTIONAL bullet COMMAND testIndices)
add_matlab_test(NAME systems/plants/test/testJointLimitConstraintsmex REQUIRES spotless OPTIONAL bullet snopt COMMAND testJointLimitConstraintsmex)
add_matlab_test(NAME systems/plants/test/testJointLimits OPTIONAL bullet COMMAND testJointLimits)
add_matlab_test(NAME systems/plants/test/testManipulatorDynamics OPTIONAL bullet COMMAND testManipulatorDynamics)
add_matlab_test(NAME systems/plants/test/testMassSpringDamper OPTIONAL bullet COMMAND testMassSpringDamper)
add_matlab_test(NAME systems/plants/test/testMassSpringDamperDynamicsGradients OPTIONAL bullet COMMAND testMassSpringDamperDynamicsGradients)
add_matlab_test(NAME systems/plants/test/testMassSpringDamperForceGradients OPTIONAL bullet COMMAND testMassSpringDamperForceGradients)
add_matlab_test(NAME systems/plants/test/testMassSpringDamperTrajOpt OPTIONAL bullet snopt COMMAND testMassSpringDamperTrajOpt)
add_matlab_test(NAME systems/plants/test/testMex OPTIONAL bullet COMMAND testMex)
add_matlab_test(NAME systems/plants/test/testParseBodyOrFrameID OPTIONAL bullet COMMAND testParseBodyOrFrameID)
add_matlab_test(NAME systems/plants/test/testPositionConstraintsmex OPTIONAL bullet COMMAND testPositionConstraintsmex)
add_matlab_test(NAME systems/plants/test/testPositionControlGradients OPTIONAL bullet gurobi COMMAND testPositionControlGradients)
add_matlab_test(NAME systems/plants/test/testRelativeTwist OPTIONAL bullet COMMAND testRelativeTwist)
add_matlab_test(NAME systems/plants/test/testRigidBodyBluffBody REQUIRES spotless OPTIONAL bullet COMMAND testRigidBodyBluffBody)
# add_matlab_test(NAME systems/plants/test/testRigidBodyInertialMeasurementUnit OPTIONAL bullet COMMAND testRigidBodyInertialMeasurementUnit)  # FIXME
add_matlab_test(NAME systems/plants/test/testRigidBodyPassByValue OPTIONAL bullet COMMAND testRigidBodyPassByValue)
add_matlab_test(NAME systems/plants/test/testRigidBodyPropellor OPTIONAL bullet COMMAND testRigidBodyPropellor)
add_matlab_test(NAME systems/plants/test/testRigidBodyWingChangingParams REQUIRES spotless OPTIONAL bullet COMMAND testRigidBodyWingChangingParams)
add_matlab_test(NAME systems/plants/test/testRigidBodyWingWithControlSurface OPTIONAL bullet COMMAND testRigidBodyWingWithControlSurface)
add_matlab_test(NAME systems/plants/test/testRigidBodyWingWithControlSurfaceOnlyControlSurface OPTIONAL bullet COMMAND testRigidBodyWingWithControlSurfaceOnlyControlSurface)
add_matlab_test(NAME systems/plants/test/testSpatialAccelerations OPTIONAL bullet COMMAND testSpatialAccelerations)
add_matlab_test(NAME systems/plants/test/testSurfaceTangentsMex REQUIRES bullet COMMAND testSurfaceTangentsMex)
add_matlab_test(NAME systems/plants/test/testTerrainContactJacobianDotTimesV OPTIONAL bullet COMMAND testTerrainContactJacobianDotTimesV)
add_matlab_test(NAME systems/plants/test/testThrust OPTIONAL bullet COMMAND testThrust)
add_matlab_test(NAME systems/plants/test/testTorsionalSpring OPTIONAL bullet COMMAND testTorsionalSpring)
add_matlab_test(NAME systems/plants/test/testTorsionalSpringGradient OPTIONAL bullet COMMAND testTorsionalSpringGradient)
# add_matlab_test(NAME systems/plants/test/testURDFmex COMMAND testURDFmex)  # FIXME: see #2013
add_matlab_test(NAME systems/plants/test/testWing REQUIRES avl xfoil OPTIONAL bullet COMMAND testWing)
add_matlab_test(NAME systems/plants/test/testWingForceGradients REQUIRES avl xfoil OPTIONAL bullet COMMAND testWingForceGradients)
add_matlab_test(NAME systems/plants/test/testdHomogTrans OPTIONAL bullet COMMAND testdHomogTrans)
add_matlab_test(NAME systems/plants/test/testdTransformSpatialMotion OPTIONAL bullet COMMAND testdTransformSpatialMotion)
add_matlab_test(NAME systems/plants/test/timeSteppingRigidBodyManipulatorFramesTest OPTIONAL bullet gurobi snopt COMMAND timeSteppingRigidBodyManipulatorFramesTest)
add_matlab_test(NAME systems/plants/test/world_link_test OPTIONAL bullet COMMAND world_link_test)

if(LONG_RUNNING_TESTS)
  add_matlab_test(NAME systems/plants/test/doublePendWBiceptSpring COMMAND doublePendWBiceptSpring PROPERTIES TIMEOUT 1500)
  add_matlab_test(NAME systems/plants/test/springPendulum COMMAND springPendulum PROPERTIES TIMEOUT 1500)
  add_matlab_test(NAME systems/plants/test/terrainInterpTest COMMAND terrainInterpTest PROPERTIES TIMEOUT 1500)
  add_matlab_test(NAME systems/plants/test/terrainTest COMMAND terrainTest PROPERTIES TIMEOUT 1500)
  add_matlab_test(NAME systems/plants/test/testAnalyticalJacobian COMMAND testAnalyticalJacobian PROPERTIES TIMEOUT 1500)
  add_matlab_test(NAME systems/plants/test/testForwardKin COMMAND testForwardKin PROPERTIES TIMEOUT 1500)
  add_matlab_test(NAME systems/plants/test/testIK COMMAND testIK PROPERTIES TIMEOUT 1500)
  add_matlab_test(NAME systems/plants/test/testIKtraj COMMAND testIKtraj PROPERTIES TIMEOUT 3000)
  add_matlab_test(NAME systems/plants/test/testInertiasInWorldFrame COMMAND testInertiasInWorldFrame PROPERTIES TIMEOUT 1500)
  add_matlab_test(NAME systems/plants/test/testMassSpringDamperThrust COMMAND testMassSpringDamperThrust PROPERTIES TIMEOUT 1500)
endif()

add_subdirectory(rigid_body_system)
add_subdirectory(rigid_body_tree)
